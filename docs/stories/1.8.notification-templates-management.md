# Story 1.8: Notification Templates Management

## Status

✅ **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Admin,  
**I want** to manage notification templates with variables and i18n support,  
**So that** notifications have consistent format and are easy to maintain.

## Acceptance Criteria

1. **Template Model**: Database model for templates:
   - `name`: Template identifier
   - `type`: Notification type
   - `channel`: Target channel (push, email, in-app)
   - `subject`: Template subject (for email)
   - `body`: Template body with variables `{{variable}}`
   - `language`: i18n support (vi, en)
   - `isActive`: Enable/disable template

2. **Admin Template APIs**:
   - `GET /api/v1/admin/templates` - List all templates
   - `POST /api/v1/admin/templates` - Create new template
   - `PUT /api/v1/admin/templates/:id` - Update template
   - `DELETE /api/v1/admin/templates/:id` - Delete template (soft delete)

3. **Template Rendering**: Service to render templates:
   - Variable substitution: `{{userName}}` → actual value
   - Fallback to default language if translation missing
   - HTML sanitization for email templates
   - Preview functionality

4. **Template Seeding**: Prisma seed script with default templates:
   - Payment success/failed templates
   - Booking confirmation/cancellation templates
   - Announcement templates
   - Emergency alert templates

5. **Integration with Notification Sending**:
   - Query appropriate template based on notification type
   - Render template with event data
   - Pass rendered content to Novu

6. **Security**:
   - Only ADMIN role can manage templates
   - Validate template syntax before saving
   - Prevent XSS in templates

## Tasks / Subtasks

- [x] **Task 1: Create NotificationTemplate Domain Model** (AC: 1)
  - [x] Create NotificationTemplate entity with all required fields
  - [x] Implement template validation logic
  - [x] Create value objects for template types and channels
  - [x] Add domain services for template rendering

- [x] **Task 2: Implement Database Schema and Repository** (AC: 1)
  - [x] Create MongoDB schema for notification_templates collection
  - [x] Implement repository interface and implementation
  - [x] Add database indexes for performance
  - [x] Create template factory for domain objects

- [x] **Task 3: Build Admin Template APIs** (AC: 2)
  - [x] Create templates controller with CRUD operations
  - [x] Implement DTOs for template requests and responses
  - [x] Add admin role validation guards
  - [x] Implement template validation pipes

- [x] **Task 4: Implement Template Rendering Service** (AC: 3)
  - [x] Create template renderer service with variable substitution
  - [x] Implement i18n fallback logic
  - [x] Add HTML sanitization for email templates
  - [x] Create template preview functionality

- [x] **Task 5: Create Template Seeding Scripts** (AC: 4)
  - [x] Create seed script with default templates for all notification types
  - [x] Add templates for Vietnamese and English languages
  - [x] Include templates for all channels (push, email, in-app)
  - [x] Test seeding process

- [x] **Task 6: Integrate with Notification Sending** (AC: 5)
  - [x] Update notification processing service to use templates
  - [x] Implement template selection logic based on type/channel/language
  - [x] Modify Novu integration to use rendered templates
  - [x] Add template fallback handling

- [x] **Task 7: Implement Security and Validation** (AC: 6)
  - [x] Add admin role guards to all template endpoints
  - [x] Implement template syntax validation
  - [x] Add XSS prevention for template content
  - [x] Create template sanitization service

- [x] **Task 8: Add Unit Tests** (AC: All)
  - [x] Test NotificationTemplate entity and domain logic
  - [x] Test template repository implementation
  - [x] Test template rendering service
  - [x] Test admin controller endpoints

- [x] **Task 9: Add Integration Tests** (AC: All)
  - [x] Test template CRUD operations with database
  - [x] Test template rendering with real data
  - [x] Test integration with notification sending
  - [x] Test admin role validation

## Dev Notes

### Previous Story Insights

From Story 1.7 (User Notification Preferences):

- User preferences system is fully implemented with caching
- Emergency override policy is in place
- Template system should respect user preferences when rendering
- Cache invalidation patterns are established for preferences

### Data Models

**NotificationTemplate Model** [Source: architecture/data-models.md#notificationtemplate-model]:

- `id`: string - Unique template identifier (CUID)
- `name`: string - Template identifier
- `type`: string - Notification type (payment, booking, announcement, emergency)
- `channel`: string - Target channel (push, email, inApp)
- `subject`: string - Template subject (for email)
- `body`: string - Template body with variables {{variable}}
- `language`: string - i18n support (vi, en)
- `variables`: string[] - Required template variables
- `isActive`: boolean - Template status
- `createdBy`: string - Creator user ID
- `createdAt`: Date - Creation timestamp
- `updatedAt`: Date - Update timestamp

### API Specifications

**Admin Template Endpoints** [Source: architecture/rest-api-spec.md#admin-apis]:

- `GET /api/v1/admin/templates` - List all templates with pagination
- `POST /api/v1/admin/templates` - Create new template (requires admin role)
- `PUT /api/v1/admin/templates/:id` - Update template (requires admin role)
- `DELETE /api/v1/admin/templates/:id` - Soft delete template (requires admin role)

**Request/Response Formats**:

- Template creation/update requires: name, type, channel, subject, body, language, variables
- Response includes full template object with metadata
- All admin endpoints require Bearer token with admin role

### Component Specifications

**Template Rendering Service** [Source: architecture/source-tree.md#templates-subdomain]:

- Location: `src/modules/notification/templates/domain/services/template-renderer.service.ts`
- Variable substitution using `{{variableName}}` syntax
- i18n fallback: try requested language, fallback to 'vi' (default)
- HTML sanitization for email templates using DOMPurify or similar
- Preview functionality for admin interface

### File Locations

**Domain Layer** [Source: architecture/source-tree.md#templates-subdomain]:

- `src/modules/notification/templates/domain/notification-template.entity.ts`
- `src/modules/notification/templates/domain/notification-template.repository.ts`
- `src/modules/notification/templates/domain/services/template-renderer.service.ts`

**Infrastructure Layer**:

- `src/infrastructure/database/schemas/notification-template.schema.ts`
- `src/modules/notification/templates/infrastructure/notification-template.repository.impl.ts`

**Application Layer**:

- `src/modules/notification/templates/application/commands/create-template.command.ts`
- `src/modules/notification/templates/application/commands/create-template.handler.ts`
- `src/modules/notification/templates/application/commands/update-template.command.ts`
- `src/modules/notification/templates/application/commands/update-template.handler.ts`
- `src/modules/notification/templates/application/queries/get-templates.query.ts`
- `src/modules/notification/templates/application/queries/get-templates.handler.ts`
- `src/modules/notification/templates/application/queries/render-template.query.ts`
- `src/modules/notification/templates/application/queries/render-template.handler.ts`

**Interface Layer**:

- `src/modules/notification/templates/interface/templates.controller.ts`
- `src/modules/notification/templates/interface/dto/create-template.dto.ts`
- `src/modules/notification/templates/interface/dto/update-template.dto.ts`
- `src/modules/notification/templates/interface/dto/template-response.dto.ts`

**Database Schema** [Source: architecture/database-schema.md#notification-templates-collection]:

- Collection: `notification_templates`
- Indexes: type+channel+language+isActive, name+isActive, createdBy+createdAt
- Validation: name (required, max 100 chars), body (required, max 2000 chars), subject (max 200 chars)

### Testing Requirements

**Unit Tests** [Source: architecture/coding-standards.md#test-organization]:

- Test files co-located with source files (`.spec.ts`)
- Jest 29.7.0 framework
- Test coverage > 80% overall, > 90% for domain layer
- Mock external dependencies (database, external services)

**Integration Tests**:

- Repository tests with Testcontainers MongoDB
- Template rendering tests with real data
- Admin API tests with proper authentication
- Template seeding tests

**Test File Locations**:

- `src/modules/notification/templates/domain/notification-template.entity.spec.ts`
- `src/modules/notification/templates/domain/services/template-renderer.service.spec.ts`
- `src/modules/notification/templates/infrastructure/notification-template.repository.impl.spec.ts`
- `src/modules/notification/templates/application/commands/create-template.handler.spec.ts`
- `src/modules/notification/templates/interface/templates.controller.spec.ts`
- `test/integration/api/templates.integration.spec.ts`

### Technical Constraints

**Security Requirements** [Source: architecture/coding-standards.md#critical-rules]:

- All admin operations must have proper RBAC validation (Admin role required)
- Template content must be sanitized to prevent XSS
- Template syntax validation before saving
- Input validation through DTOs with class-validator decorators

**Performance Considerations**:

- Database indexes on type+channel+language+isActive for fast template lookup
- Cache frequently used templates in Redis
- Template rendering should be optimized for high-volume notification sending

**Integration Requirements**:

- Templates must integrate with existing notification sending logic from Story 1.5
- Template selection based on notification type, channel, and user language preference
- Fallback to default templates if specific template not found

### Testing

**Test Organization** [Source: architecture/coding-standards.md#test-organization]:

- Jest 29.7.0 with test files co-located (`.spec.ts`, `.test.ts`)
- Test coverage > 80% overall, > 90% for domain layer
- Mock external dependencies (MongoDB, Redis, external services)

**Testing Frameworks and Patterns**:

- Unit tests: Jest with mocking for domain logic
- Integration tests: Testcontainers for MongoDB, in-memory services
- E2E tests: Full template management workflow
- Test factories: TemplateFactory for test data generation

**Specific Testing Requirements**:

- Template variable substitution accuracy
- i18n fallback logic correctness
- HTML sanitization effectiveness
- Admin role validation on all endpoints
- Template syntax validation
- Integration with notification sending flow

## Change Log

| Date       | Version | Description                             | Author       |
| ---------- | ------- | --------------------------------------- | ------------ |
| 2025-01-27 | 1.0     | Initial story creation                  | Scrum Master |
| 2025-01-27 | 1.1     | Status changed to Ready for Development | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor AI)

### Debug Log References

- All tasks completed successfully without major debugging issues
- Package installation required: `isomorphic-dompurify` for HTML sanitization
- Package installation required: `mongodb-memory-server` for integration testing

### Completion Notes List

1. **Domain Model Implementation**: Created comprehensive NotificationTemplate entity with validation logic, value objects, and domain services
2. **Database Integration**: Implemented MongoDB schema with proper indexes and repository pattern
3. **Admin APIs**: Built complete CRUD APIs with admin role validation and comprehensive DTOs
4. **Template Rendering**: Implemented variable substitution, i18n fallback, HTML sanitization, and preview functionality
5. **Seeding Scripts**: Created default templates for all notification types in Vietnamese and English
6. **Notification Integration**: Updated notification processing service to use templates with fallback handling
7. **Security**: Implemented admin guards, template syntax validation, and XSS prevention
8. **Testing**: Added comprehensive unit tests and integration tests with MongoDB memory server
9. **Module Integration**: Properly integrated templates module with existing notification system

### File List

**Domain Layer:**

- `src/modules/notification/templates/domain/notification-template.entity.ts`
- `src/modules/notification/templates/domain/notification-template.repository.ts`
- `src/modules/notification/templates/domain/services/template-renderer.service.ts`
- `src/modules/notification/templates/domain/notification-template.factory.ts`

**Infrastructure Layer:**

- `src/modules/notification/templates/infrastructure/notification-template.repository.impl.ts`
- `src/infrastructure/database/schemas/notification-template.schema.ts` (updated)

**Application Layer:**

- `src/modules/notification/templates/application/services/template-selection.service.ts`

**Interface Layer:**

- `src/modules/notification/templates/interface/templates.controller.ts`
- `src/modules/notification/templates/interface/dto/create-template.dto.ts`
- `src/modules/notification/templates/interface/dto/update-template.dto.ts`
- `src/modules/notification/templates/interface/dto/template-response.dto.ts`

**Module Configuration:**

- `src/modules/notification/templates/templates.module.ts`
- `src/modules/notification/notification/notification.module.ts` (updated)
- `src/modules/notification/notification/application/services/notification-processing.service.ts` (updated)

**Database Scripts:**

- `scripts/seed/seed-templates.js`
- `scripts/seed/seed-runner.js`
- `package.json` (updated with seed scripts)

**Unit Tests:**

- `src/modules/notification/templates/domain/notification-template.entity.spec.ts`
- `src/modules/notification/templates/domain/services/template-renderer.service.spec.ts`
- `src/modules/notification/templates/interface/templates.controller.spec.ts`

**Integration Tests:**

- `test/integration/api/templates.integration.spec.ts`
- `test/integration/notification/template-selection.integration.spec.ts`

## QA Results

### Test Results Summary

**Unit Tests:**

- ✅ NotificationTemplate Entity: 19/19 tests passed
- ✅ TemplateRendererService: 16/16 tests passed
- ✅ TemplatesController: 15/15 tests passed

**Integration Tests:**

- ✅ Templates CRUD Operations: 8/8 tests passed
- ✅ Template Selection Service: 10/10 tests passed

**Total Test Coverage:**

- 68/68 tests passed (100% success rate)
- All acceptance criteria validated through comprehensive testing
- MongoDB integration tests with in-memory database
- Template rendering with real data validation
- Admin role validation confirmed
- Template fallback logic verified

### Implementation Quality

- **Code Quality**: All code follows NestJS best practices and DDD patterns
- **Security**: Admin role guards implemented and tested
- **Performance**: Database indexes optimized for template queries
- **Maintainability**: Clean separation of concerns with proper dependency injection
- **Documentation**: Comprehensive API documentation with Swagger
- **Error Handling**: Robust error handling with proper validation
