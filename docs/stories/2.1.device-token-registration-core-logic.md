# Story 2.1: Device Token Registration & Core Logic

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Backend Developer,  
**I want** to implement device token registration APIs and core notification sending logic,  
**So that** service can manage device tokens and process notifications via Novu.

## Acceptance Criteria

1. **Device Token Registration API**: `POST /api/v1/device-tokens`
   - Register FCM/APNS device tokens for push notifications
   - Request body:
     ```json
     {
       "token": "fcm_token_string",
       "platform": "android",
       "deviceId": "unique_device_id"
     }
     ```
   - Validate JWT token from Auth Service
   - Create/update device token in database
   - Sync with Novu subscriber
   - Return success response

2. **Device Token Management**: `GET /api/v1/device-tokens`
   - List user's registered device tokens
   - Show token status (active, inactive)
   - Include last used timestamp
   - Support pagination

3. **Device Token Deletion**: `DELETE /api/v1/device-tokens/:id`
   - Remove device token from database
   - Remove from Novu subscriber
   - Log deletion action

4. **Core Notification Logic**: Domain aggregate with business logic:
   - Create notification from event data
   - Validate notification data
   - Apply business rules (priority, targeting, channels)
   - Emit domain events (NotificationCreated, NotificationSent, NotificationFailed)

5. **Notification Processing Flow**:
   - Receive event from RabbitMQ consumer
   - Query target users from Auth Service (if targeting by role)
   - Get user tokens and preferences from database
   - Filter users based on preferences (opt-out handling)
   - Create notification records in database
   - Trigger Novu workflows for each channel (push, in-app, email)
   - Update notification status (sent, failed)

6. **Role-based Targeting**:
   - Query Auth Service API: `GET /users/by-role?role={role}`
   - Support multiple roles targeting
   - Support individual user targeting (userId array)

7. **Channel Selection Logic**:
   - Respect user preferences per channel type
   - Fallback logic if preferred channel fails
   - Parallel sending for multiple channels

8. **Priority Handling**:
   - URGENT: Send immediately, bypass preferences (emergency alerts)
   - HIGH: Send with high priority, respect critical preferences only
   - NORMAL: Standard processing
   - LOW: Can be batched or delayed

9. **Error Handling**:
   - Catch Novu API errors
   - Retry failed sends with exponential backoff
   - Log failures for monitoring

## Tasks / Subtasks

- [x] **Task 1: Device Token Registration API** (AC: 1)
  - [x] Create device token DTO with validation
  - [x] Implement device token controller with JWT validation
  - [x] Create device token service with database operations
  - [x] Integrate with Novu subscriber sync
  - [x] Add proper error handling and responses

- [x] **Task 2: Device Token Management** (AC: 2, 3)
  - [x] Create device token listing API with pagination
  - [x] Implement device token deletion API
  - [x] Add device token status tracking
  - [x] Create device token repository with proper queries

- [x] **Task 3: Notification Domain Aggregate** (AC: 4)
  - [x] Create Notification aggregate with business logic
  - [x] Implement notification creation from event data
  - [x] Add validation rules for notification data
  - [x] Implement business rules for priority, targeting, channels
  - [x] Add domain events (NotificationCreated, NotificationSent, NotificationFailed)
  - [x] Create value objects for notification type, channel, priority, status

- [x] **Task 4: Notification Processing Service** (AC: 5, 6, 7, 8)
  - [x] Create NotificationProcessingService
  - [x] Implement event processing from RabbitMQ consumer
  - [x] Add Auth Service integration for role-based targeting
  - [x] Implement user preference filtering logic
  - [x] Add channel selection and fallback logic
  - [x] Implement priority handling (URGENT, HIGH, NORMAL, LOW)
  - [x] Add parallel sending for multiple channels

- [x] **Task 5: Notification Repository and Infrastructure** (AC: 5)
  - [x] Implement NotificationRepository interface
  - [x] Create NotificationRepository implementation with Mongoose
  - [x] Add notification record creation and status updates
  - [x] Implement batch operations for high-volume notifications
  - [x] Add proper indexing for performance

- [x] **Task 6: Novu API Integration** (AC: 5, 9)
  - [x] Create NovuNotificationService
  - [x] Implement workflow triggering for each channel
  - [x] Add error handling and retry logic with exponential backoff
  - [x] Implement circuit breaker pattern for Novu API calls
  - [x] Add delivery status tracking and updates

- [x] **Task 7: Unit Tests** (AC: All)
  - [x] Test device token registration and management
  - [x] Test Notification aggregate business logic
  - [x] Test NotificationProcessingService with mocked dependencies
  - [x] Test repository operations
  - [x] Test Novu integration service
  - [x] Test error handling and retry logic

- [x] **Task 8: Integration Tests** (AC: All)
  - [x] Test device token API with real database
  - [x] Test complete notification processing flow
  - [x] Test Auth Service integration
  - [x] Test Novu API integration with mocked responses
  - [x] Test database operations with Testcontainers

## Dev Notes

### Previous Story Insights

From Story 1.1-1.3 (Foundation Stories):

- Database schemas and infrastructure are established
- Novu client integration is complete
- RabbitMQ consumer is operational
- All foundation components are ready for core logic implementation

### Data Models

**Device Token Model** [Source: architecture/data-models.md#device-token-model]:

- `id`: string (CUID) - Unique token identifier
- `userId`: string - Reference to User
- `token`: string - FCM/APNS/Expo push token
- `platform`: string - Device platform (ios, android, web)
- `provider`: string - Push provider (fcm, apns, expo)
- `deviceId`: string - Unique device identifier
- `isActive`: boolean - Token status
- `lastUsedAt`: Date - Last successful push timestamp
- `createdAt`, `updatedAt`: Date - Timestamps

**Notification Aggregate** [Source: architecture/data-models.md#announcement-model]:

- `id`: string (CUID)
- `title`: string (max 200 chars)
- `body`: string (max 1000 chars)
- `type`: "payment" | "booking" | "announcement" | "emergency"
- `priority`: "urgent" | "high" | "normal" | "low"
- `channels`: ("push" | "email" | "inApp")[]
- `targetRoles`: string[] (admin, resident, staff, manager)
- `targetUsers`: string[] (optional specific users)
- `data`: Record<string, any>
- `status`: "draft" | "scheduled" | "sent" | "failed"

### API Specifications

**Device Token Endpoints** [Source: architecture/rest-api-spec.md#device-tokens]:

- `POST /api/v1/device-tokens` - Register device token
- `GET /api/v1/device-tokens` - List user's device tokens
- `DELETE /api/v1/device-tokens/:id` - Remove device token

**Auth Service Integration** [Source: architecture/external-apis.md#auth-service-api]:

- Base URL: `{AUTH_SERVICE_URL}/api/v1`
- `GET /users/by-role?role={role}` - Query users by role
- `GET /users/batch` - Batch query multiple users
- Cache role data in Redis with TTL 10 minutes
- Use circuit breaker for resilience

**Novu API Integration** [Source: architecture/external-apis.md#novu-self-hosted-api]:

- Base URL: `{NOVU_API_URL}/v1`
- Authentication: `Authorization: ApiKey {NOVU_API_KEY}`
- `POST /events/trigger` - Trigger notification workflow
- `GET /events/{eventId}` - Get delivery status
- Rate limit: 1000 requests/minute
- Use circuit breaker pattern and retry with exponential backoff

### File Locations

Based on project structure [Source: architecture/source-tree.md]:

**Device Token Module:**

- `src/modules/notification/device-tokens/domain/` - Domain entities
- `src/modules/notification/device-tokens/application/` - Commands and queries
- `src/modules/notification/device-tokens/infrastructure/` - Repository implementation
- `src/modules/notification/device-tokens/interface/` - API controllers

**Notification Core Module:**

- `src/modules/notification/notification/domain/` - Notification aggregate
- `src/modules/notification/notification/application/` - Processing services
- `src/modules/notification/notification/infrastructure/` - Repository implementation

### Technical Constraints

**Coding Standards** [Source: architecture/coding-standards.md]:

- Use CUID for all entity IDs (never MongoDB ObjectId)
- All external API calls must have circuit breaker protection
- All notification sending must respect user preferences
- All database operations must use transactions for multi-document updates
- Never use console.log - use Winston logger
- All API responses must use ApiResponse wrapper type

### Testing Requirements

**Testing Standards** [Source: architecture/coding-standards.md]:

- Jest 29.7.0 with test files co-located (`.spec.ts`, `.test.ts`)
- Unit tests for domain logic and services
- Integration tests with Testcontainers for database operations
- Mock external API calls (Auth Service, Novu)
- Test error handling and retry logic
- Test circuit breaker behavior

## Change Log

| Date       | Version | Description                    | Author       |
| ---------- | ------- | ------------------------------ | ------------ |
| 2025-01-27 | 1.0     | Initial story creation         | Scrum Master |
| 2025-01-27 | 1.1     | Story approved for development | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after implementation_
