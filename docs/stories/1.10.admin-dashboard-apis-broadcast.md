# Story 1.10: Admin Dashboard APIs & Broadcast

## Status

✅ **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Admin,  
**I want** APIs to view notification statistics and broadcast notifications to groups,  
**So that** can monitor system and send announcements.

## Acceptance Criteria

1. **Notification Statistics**: `GET /api/v1/admin/statistics`
   - Total notifications sent (today, this week, this month)
   - Breakdown by channel (push, email, in-app)
   - Breakdown by status (sent, failed, pending)
   - Delivery rate percentage
   - Top notification types
   - Failed notification reasons

2. **Broadcast Notification**: `POST /api/v1/admin/broadcast`
   - Send notification to multiple target groups
   - Request body:
     ```json
     {
       "title": "Announcement title",
       "body": "Announcement body",
       "targetRoles": ["resident", "staff"],
       "targetUsers": ["user1", "user2"], // Optional specific users
       "channels": ["push", "email", "inApp"],
       "priority": "HIGH",
       "scheduledAt": "2025-10-20T10:00:00Z" // Optional
     }
     ```
   - Validate admin role
   - Query target users from Auth Service
   - Create notification records
   - Trigger sending logic

3. **Scheduled Broadcasts**:
   - Support scheduled notifications (send at specific time)
   - Background job to check and send scheduled notifications
   - Cancel scheduled notification API

4. **Failed Notifications Report**: `GET /api/v1/admin/failed`
   - List failed notifications with pagination
   - Filter by: date range, error type, notification type
   - Include: error details, retry attempts, user info
   - Export to CSV functionality

5. **Manual Retry**: `POST /api/v1/admin/notifications/:id/retry`
   - Admin can manually trigger retry for failed notification
   - Bypass retry count limit
   - Log manual retry action

6. **Security & RBAC**:
   - All admin APIs require ADMIN role
   - Audit log for broadcast actions
   - Rate limiting for broadcast API (prevent abuse)

## Tasks / Subtasks

- [x] **Task 1: Admin Statistics API** (AC: 1)
  - [x] Create admin statistics service with aggregation queries
  - [x] Implement statistics controller with proper RBAC
  - [x] Add caching for expensive statistics queries
  - [x] Create statistics DTOs and response models

- [x] **Task 2: Broadcast Notification API** (AC: 2)
  - [x] Create broadcast notification DTO with validation
  - [x] Implement broadcast service with user targeting logic
  - [x] Create broadcast controller with admin role validation
  - [x] Integrate with existing notification sending logic

- [x] **Task 3: Scheduled Broadcasts** (AC: 3)
  - [x] Create scheduled notification schema and model
  - [x] Implement background job for scheduled notifications
  - [x] Add cancel scheduled notification API
  - [x] Create scheduled notification management service

- [x] **Task 4: Failed Notifications Report** (AC: 4)
  - [x] Create failed notifications query service
  - [x] Implement pagination and filtering for failed notifications
  - [x] Add CSV export functionality
  - [x] Create failed notifications controller

- [x] **Task 5: Manual Retry API** (AC: 5)
  - [x] Create manual retry service bypassing retry limits
  - [x] Implement manual retry controller
  - [x] Add audit logging for manual retry actions
  - [x] Integrate with existing retry worker

- [x] **Task 6: Security & RBAC Implementation** (AC: 6)
  - [x] Create admin guard for role-based access control
  - [x] Implement rate limiting for admin APIs
  - [x] Add audit logging for admin actions
  - [x] Create admin decorator for controller methods

- [x] **Task 7: Unit Tests** (AC: All)
  - [x] Test admin statistics service with mocked data
  - [x] Test broadcast notification service with various scenarios
  - [x] Test scheduled notification background job
  - [x] Test failed notifications report with pagination
  - [x] Test manual retry functionality
  - [x] Test admin RBAC and security guards

- [x] **Task 8: Integration Tests** (AC: All)
  - [x] Test admin APIs with real database and Auth Service
  - [x] Test broadcast notification end-to-end flow
  - [x] Test scheduled notification processing
  - [x] Test failed notification reporting and CSV export
  - [x] Test manual retry with actual failed notifications

## Dev Notes

### Previous Story Insights

- Story 1.9 completed retry mechanism and error handling infrastructure
- Circuit breaker pattern is implemented for Novu API calls
- Retry worker is operational with exponential backoff
- Dead letter queue system is in place for failed notifications

### Data Models

[Source: architecture/data-models.md#announcement-model]

- **Announcement Model**: Core notification content with targeting, scheduling, and status fields
- **UserNotification Model**: Personal inbox with delivery status and retry tracking
- **User Model**: User information with roles for targeting
- **Category Model**: Logical grouping for notification targeting

### API Specifications

[Source: architecture/rest-api-spec.md#admin-apis]

- **Admin Statistics**: `GET /api/v1/admin/statistics` with date range filtering
- **Broadcast Notification**: `POST /api/v1/admin/broadcast` with role/user targeting
- **Failed Notifications**: `GET /api/v1/admin/failed` with pagination and filtering
- **Manual Retry**: `POST /api/v1/admin/notifications/:id/retry` bypassing retry limits
- **Security**: All admin endpoints require ADMIN role with BearerAuth

### Component Specifications

[Source: architecture/source-tree.md#admin-module]

- **Admin Module**: `src/modules/notification/admin/` with controller and DTOs
- **Admin Controller**: `admin.controller.ts` with RBAC guards
- **Admin DTOs**: `broadcast-notification.dto.ts`, `notification-statistics.dto.ts`, `failed-notification.dto.ts`
- **Admin Service**: Statistics aggregation, broadcast processing, failed notification management

### File Locations

[Source: architecture/source-tree.md#admin-module]

- **Admin Controller**: `src/modules/notification/admin/interface/admin.controller.ts`
- **Admin DTOs**: `src/modules/notification/admin/interface/dto/`
- **Admin Service**: `src/modules/notification/admin/application/`
- **Scheduled Jobs**: `src/workers/scheduled-notification.worker.ts`
- **Admin Guards**: `src/common/guards/admin.guard.ts`

### Technical Constraints

[Source: architecture/coding-standards.md#critical-rules]

- All admin operations must have proper RBAC validation
- Admin role required for admin endpoints
- All API responses must use ApiResponse wrapper type
- Database queries must use repository pattern
- All external API calls must have circuit breaker protection
- JWT token validation must be done via Auth Service

### Testing Requirements

[Source: architecture/test-strategy-and-standards.md]

- **Unit Tests**: Jest 29.7.0 with 80% coverage minimum
- **Integration Tests**: Testcontainers MongoDB, WireMock for external APIs
- **Test Location**: Mirror source structure in `test/unit/` and `test/integration/`
- **Mocking**: Jest built-in mocking for external services (Novu, Auth Service)
- **Test Data**: Factory pattern with builder pattern for complex objects

### Security Requirements

[Source: architecture/security.md]

- **Rate Limiting**: 100 requests/minute for admin endpoints
- **RBAC**: Admin role validation for all admin APIs
- **Audit Logging**: Log all admin actions for security monitoring
- **Input Validation**: class-validator for all admin API inputs
- **Secrets Management**: Environment variables for API keys

## Testing

### Testing Standards

[Source: architecture/test-strategy-and-standards.md]

- **Framework**: Jest 29.7.0 with TypeScript support
- **File Convention**: `*.spec.ts` for unit tests, co-located with source files
- **Coverage Requirement**: 80% minimum, 90% for domain layer
- **Test Pattern**: AAA pattern (Arrange, Act, Assert)
- **Mocking**: Mock all external dependencies (Novu, Auth Service, RabbitMQ)

### Test Organization

- **Unit Tests**: `test/unit/modules/notification/admin/`
- **Integration Tests**: `test/integration/api/admin/`
- **E2E Tests**: `test/e2e/admin-flow.e2e-spec.ts`
- **Test Factories**: `test/factories/announcement.factory.ts`, `test/factories/user.factory.ts`

### Specific Testing Requirements

- Test admin RBAC with different user roles
- Test broadcast notification with various targeting scenarios
- Test scheduled notification background job processing
- Test failed notification reporting with large datasets
- Test manual retry bypassing automatic retry limits
- Test rate limiting for admin APIs
- Test CSV export functionality for failed notifications

## Change Log

| Date       | Version | Description                     | Author       |
| ---------- | ------- | ------------------------------- | ------------ |
| 2025-01-27 | 1.0     | Initial story creation          | Scrum Master |
| 2025-01-27 | 1.1     | Status updated to Ready for Dev | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor)

### Debug Log References

- All implementation completed successfully without major debugging issues
- Minor linting fixes applied during development
- All tests passing without errors

### Completion Notes List

- ✅ **Task 1: Admin Statistics API** - Created comprehensive statistics service with caching, aggregation queries, and proper DTOs
- ✅ **Task 2: Broadcast Notification API** - Implemented broadcast service with user targeting, validation, and integration with Auth Service
- ✅ **Task 3: Scheduled Broadcasts** - Created scheduled notification service with cron job processing and management APIs
- ✅ **Task 4: Failed Notifications Report** - Implemented pagination, filtering, and CSV export functionality
- ✅ **Task 5: Manual Retry API** - Created manual retry service with audit logging and bypass retry limits
- ✅ **Task 6: Security & RBAC** - Implemented rate limiting, audit logging, and enhanced admin guard
- ✅ **Task 7: Unit Tests** - Created comprehensive unit tests for all services and controllers
- ✅ **Task 8: Integration Tests** - Created end-to-end integration tests for all admin APIs

### File List

**New Files Created:**

- `src/modules/notification/admin/admin.module.ts`
- `src/modules/notification/admin/interface/admin.controller.ts`
- `src/modules/notification/admin/interface/dto/notification-statistics.dto.ts`
- `src/modules/notification/admin/interface/dto/broadcast-notification.dto.ts`
- `src/modules/notification/admin/interface/dto/failed-notification.dto.ts`
- `src/modules/notification/admin/application/services/admin-statistics.service.ts`
- `src/modules/notification/admin/application/services/broadcast-notification.service.ts`
- `src/modules/notification/admin/application/services/failed-notification.service.ts`
- `src/modules/notification/admin/application/services/manual-retry.service.ts`
- `src/modules/notification/admin/application/services/scheduled-notification.service.ts`
- `src/common/guards/rate-limit.guard.ts`
- `src/common/decorators/rate-limit.decorator.ts`
- `src/common/services/audit-log.service.ts`
- `src/infrastructure/database/schemas/audit-log.schema.ts`

**Test Files Created:**

- `src/modules/notification/admin/application/services/admin-statistics.service.spec.ts`
- `src/modules/notification/admin/application/services/broadcast-notification.service.spec.ts`
- `src/modules/notification/admin/application/services/failed-notification.service.spec.ts`
- `src/modules/notification/admin/application/services/manual-retry.service.spec.ts`
- `src/modules/notification/admin/application/services/scheduled-notification.service.spec.ts`
- `src/modules/notification/admin/interface/admin.controller.spec.ts`
- `test/integration/api/admin/admin-statistics.integration.spec.ts`
- `test/integration/api/admin/admin-broadcast.integration.spec.ts`
- `test/integration/api/admin/admin-failed-notifications.integration.spec.ts`
- `test/integration/api/admin/admin-manual-retry.integration.spec.ts`

**Modified Files:**

- `src/app.module.ts` - Added AdminModule import
- `src/infrastructure/external/auth-service/auth-service.client.ts` - Added getUsersByRoles method

## QA Results

_Results from QA Agent review will be added here after implementation_
