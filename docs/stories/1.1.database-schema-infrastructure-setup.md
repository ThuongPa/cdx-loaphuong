# Story 1.1: Database Schema & Infrastructure Setup

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Backend Developer,  
**I want** to set up database schema, Prisma ORM, and basic NestJS project structure,  
**So that** there's a foundation to develop notification service features.

## Acceptance Criteria

1. **Database Schema**: Complete MongoDB collections with Mongoose schemas:
   - `users`: store user profile information synced from Auth Service
   - `device_tokens`: manage FCM/APNS device tokens for push notifications
   - `announcements`: store core notification content and metadata
   - `user_notifications`: user's personal notification inbox
   - `categories`: logical grouping for targeted notifications
   - `category_members`: many-to-many relationship between users and categories
   - Indexes created for performance-critical queries

2. **Project Structure**: NestJS project with DDD + CQRS structure:
   - Common utilities (decorators, guards, interceptors, pipes)
   - Config module for database, Redis, RabbitMQ, Novu
   - Infrastructure layer (Mongoose, Redis, RabbitMQ services)
   - Module structure for notification, device-token, preferences, categories, templates

3. **Development Environment**: Docker Compose setup with:
   - MongoDB database
   - Redis cache
   - RabbitMQ message broker
   - Novu self-hosted (optional for local dev)

4. **Health Checks**: `/health` endpoint returns status of all dependencies (DB, Redis, RabbitMQ, Novu)

5. **Testing Infrastructure**: Jest configuration with test factories and fixtures

## Tasks / Subtasks

- [x] Task 1: Setup NestJS Project Structure (AC: 2)
  - [x] Initialize NestJS project with Fastify adapter
  - [x] Configure TypeScript with strict mode
  - [x] Setup ESLint and Prettier configuration
  - [x] Create basic folder structure following DDD + CQRS pattern
  - [x] Setup package.json with required dependencies

- [x] Task 2: Database Schema Implementation (AC: 1)
  - [x] Create Mongoose schemas for all 8 collections
  - [x] Implement proper indexes for performance-critical queries
  - [x] Add TTL indexes for data cleanup
  - [x] Create schema validation and constraints
  - [x] Setup database connection service

- [x] Task 3: Infrastructure Layer Setup (AC: 2)
  - [x] Create MongoDB connection service with Mongoose
  - [x] Setup Redis cache service
  - [x] Create RabbitMQ connection service
  - [x] Setup configuration module for all external services
  - [x] Implement circuit breaker pattern for external services

- [x] Task 4: Common Utilities and Cross-cutting Concerns (AC: 2)
  - [x] Create decorators (current-user, roles, api-response, admin-only)
  - [x] Implement guards (jwt-auth, roles, admin)
  - [x] Create interceptors (logging, transform, timeout, cache)
  - [x] Setup pipes (validation, parse-cuid, parse-int)
  - [x] Create DTOs and enums for common types

- [x] Task 5: Development Environment Setup (AC: 3)
  - [x] Create Docker Compose configuration
  - [x] Setup MongoDB container with proper configuration
  - [x] Setup Redis container
  - [x] Setup RabbitMQ container with exchanges and queues
  - [x] Create environment configuration files

- [x] Task 6: Health Check Implementation (AC: 4)
  - [x] Create health check controller
  - [x] Implement health check service
  - [x] Add dependency status checks (DB, Redis, RabbitMQ, Novu)
  - [x] Create health check module

- [x] Task 7: Testing Infrastructure Setup (AC: 5)
  - [x] Configure Jest with TypeScript support
  - [x] Setup test database with Testcontainers
  - [x] Create test factories for all entities
  - [x] Setup test fixtures and data builders
  - [x] Configure test environment variables

## Dev Notes

### Previous Story Insights

No previous stories - this is the foundation story.

### Data Models

Based on architecture documents, the following MongoDB collections need to be implemented:

**Users Collection** [Source: architecture/data-models.md#user-model]

- `_id`: string (CUID) - Unique user identifier
- `email`: string - User email for email notifications
- `phone`: string - User phone for SMS notifications (optional)
- `roles`: string[] - User roles for role-based targeting
- `isActive`: boolean - User account status
- `lastSyncedAt`: Date - Last sync timestamp with Auth Service
- `createdAt`, `updatedAt`: Date - Timestamps

**Device Tokens Collection** [Source: architecture/data-models.md#devicetoken-model]

- `_id`: string (CUID) - Unique token identifier
- `userId`: string - Reference to User
- `token`: string - FCM/APNS/Expo push token
- `platform`: string - Device platform (ios, android, web)
- `provider`: string - Push provider (fcm, apns, expo)
- `deviceId`: string - Unique device identifier
- `isActive`: boolean - Token status
- `lastUsedAt`: Date - Last successful push timestamp
- `createdAt`, `updatedAt`: Date - Timestamps

**Announcements Collection** [Source: architecture/data-models.md#announcement-model]

- `_id`: string (CUID) - Unique announcement identifier
- `title`: string - Notification title
- `body`: string - Notification body content
- `type`: string - Notification type (payment, booking, announcement, emergency)
- `priority`: string - Priority level (urgent, high, normal, low)
- `channels`: string[] - Target channels (push, email, inApp)
- `targetRoles`: string[] - Target user roles
- `targetUsers`: string[] - Specific target users (optional)
- `data`: object - Additional notification data
- `templateId`: string - Reference to notification template (optional)
- `scheduledAt`: Date - Scheduled send time (optional)
- `status`: string - Announcement status (draft, scheduled, sent, failed)
- `createdBy`: string - Creator user ID
- `createdAt`, `updatedAt`: Date - Timestamps

**User Notifications Collection** [Source: architecture/data-models.md#usernotification-model]

- `_id`: string (CUID) - Unique notification identifier
- `userId`: string - Reference to User
- `announcementId`: string - Reference to Announcement
- `title`: string - Notification title (copied from announcement)
- `body`: string - Notification body (copied from announcement)
- `type`: string - Notification type
- `channel`: string - Delivery channel (push, email, inApp)
- `priority`: string - Priority level
- `data`: object - Additional notification data
- `status`: string - Delivery status (pending, sent, delivered, failed, read)
- `sentAt`: Date - When notification was sent
- `deliveredAt`: Date - When notification was delivered
- `readAt`: Date - When user read the notification
- `errorMessage`: string - Error details for failed notifications
- `retryCount`: number - Number of retry attempts
- `createdAt`, `updatedAt`: Date - Timestamps

**Categories Collection** [Source: architecture/data-models.md#category-model]

- `_id`: string (CUID) - Unique category identifier
- `name`: string - Category name
- `description`: string - Category description
- `type`: string - Category type (building, floor, apartment, custom)
- `isActive`: boolean - Category status
- `createdBy`: string - Creator user ID
- `createdAt`, `updatedAt`: Date - Timestamps

**Category Members Collection** [Source: architecture/data-models.md#categorymember-model]

- `_id`: string (CUID) - Unique membership identifier
- `categoryId`: string - Reference to Category
- `userId`: string - Reference to User
- `joinedAt`: Date - When user joined category
- `isActive`: boolean - Membership status

**User Preferences Collection** [Source: architecture/data-models.md#userpreferences-model]

- `_id`: string (CUID) - Unique preference identifier
- `userId`: string - Reference to User
- `channels`: object - Channel preferences {push: boolean, email: boolean, inApp: boolean}
- `types`: object - Type preferences {payment: boolean, booking: boolean, announcement: boolean, emergency: boolean}
- `quietHours`: object - Quiet hours settings {enabled: boolean, start: string, end: string}
- `createdAt`, `updatedAt`: Date - Timestamps

**Notification Templates Collection** [Source: architecture/data-models.md#notificationtemplate-model]

- `_id`: string (CUID) - Unique template identifier
- `name`: string - Template identifier
- `type`: string - Notification type
- `channel`: string - Target channel (push, email, inApp)
- `subject`: string - Template subject (for email)
- `body`: string - Template body with variables {{variable}}
- `language`: string - i18n support (vi, en)
- `variables`: string[] - Required template variables
- `isActive`: boolean - Template status
- `createdBy`: string - Creator user ID
- `createdAt`, `updatedAt`: Date - Timestamps

### API Specifications

No specific API endpoints required for this story - this is infrastructure setup only.

### Component Specifications

No UI components required for this story - this is backend infrastructure setup.

### File Locations

Based on source tree structure [Source: architecture/source-tree.md]:

**Core Application Files:**

- `src/main.ts` - Application entry point
- `src/app.module.ts` - Root application module

**Common Utilities:**

- `src/common/decorators/` - Custom decorators
- `src/common/guards/` - Authentication and authorization guards
- `src/common/interceptors/` - Cross-cutting concerns
- `src/common/pipes/` - Input validation pipes
- `src/common/dto/` - Common DTOs
- `src/common/enums/` - Application enums
- `src/common/utils/` - Utility functions
- `src/common/constants/` - Application constants

**Configuration:**

- `src/config/` - All configuration modules

**Infrastructure Layer:**

- `src/infrastructure/database/` - MongoDB schemas and connection
- `src/infrastructure/cache/` - Redis cache service
- `src/infrastructure/messaging/` - RabbitMQ services
- `src/infrastructure/external/` - External service integrations

**Health Check:**

- `src/modules/health/` - Health check module

**Testing:**

- `test/unit/` - Unit tests
- `test/integration/` - Integration tests
- `test/factories/` - Test data factories
- `test/fixtures/` - Static test data

**Infrastructure as Code:**

- `infrastructure/docker/` - Docker configuration
- `scripts/migrations/` - Database migration scripts

### Testing Requirements

Based on testing strategy [Source: architecture/test-strategy-and-standards.md]:

**Testing Framework:** Jest 29.7.0 with TypeScript support
**Test File Convention:** `*.spec.ts` for unit tests, co-located with source files
**Test Location:** Mirror source structure in `test/unit/` directory
**Coverage Requirement:** 80% minimum overall, 90% for domain layer

**Test Infrastructure:**

- **MongoDB:** Testcontainers MongoDB for isolated database testing
- **Redis:** Embedded Redis server for cache testing
- **RabbitMQ:** Testcontainers RabbitMQ for message queue testing

**Test Data Management:**

- Factory pattern with builder pattern for complex objects
- Static test data in `test/fixtures/` directory
- Dynamic test data generation in `test/factories/` directory
- Automatic cleanup after each test with database truncation

### Technical Constraints

Based on coding standards [Source: architecture/coding-standards.md]:

**Core Standards:**

- TypeScript 5.3.3, Node.js 20.11.0 LTS, NestJS 10.3.2 with Fastify adapter
- ESLint 8.55.0 + Prettier 3.1.0 with strict TypeScript configuration
- Jest 29.7.0 with test files co-located

**Critical Rules:**

- Never use console.log in production code - Always use Winston logger
- All API responses must use ApiResponse wrapper type
- Database queries must use repository pattern - Never direct Mongoose calls outside repository layer
- All external API calls must have circuit breaker protection
- JWT token validation must be done via Auth Service
- All database operations must use transactions for multi-document updates
- Use CUID for all entity IDs - never use MongoDB ObjectId
- DTOs must use class-validator decorators
- Use dependency injection pattern - NestJS standard
- Async/await preferred over Promises

### Project Structure Notes

The project structure follows DDD + CQRS patterns with clear separation of concerns:

- Application layer handles commands and queries
- Domain layer contains business logic
- Infrastructure layer handles external integrations
- Interface layer handles API endpoints

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-01-16 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor)

### Debug Log References

No debug logs required for this implementation.

### Completion Notes List

- âœ… **Task 1**: NestJS project structure created with Fastify adapter, TypeScript strict mode, ESLint/Prettier configuration, and DDD + CQRS folder structure
- âœ… **Task 2**: All 8 MongoDB collections implemented with Mongoose schemas, proper indexes, TTL indexes, and validation
- âœ… **Task 3**: Infrastructure layer completed with MongoDB, Redis, RabbitMQ services, configuration modules, and circuit breaker pattern
- âœ… **Task 4**: Common utilities implemented including decorators, guards, interceptors, pipes, DTOs, and enums
- âœ… **Task 5**: Docker Compose environment setup with MongoDB, Redis, RabbitMQ containers and configuration files
- âœ… **Task 6**: Health check implementation with dependency status checks for all services
- âœ… **Task 7**: Testing infrastructure setup with Jest configuration, test factories, fixtures, and test examples

### File List

**Core Application Files:**

- `src/main.ts` - Application entry point with Fastify adapter
- `src/app.module.ts` - Root application module with configuration
- `package.json` - Dependencies and scripts
- `tsconfig.json` - TypeScript configuration
- `.eslintrc.js` - ESLint configuration
- `.prettierrc` - Prettier configuration
- `jest.config.js` - Jest testing configuration

**Configuration Files:**

- `src/config/database.config.ts` - MongoDB configuration
- `src/config/redis.config.ts` - Redis configuration
- `src/config/rabbitmq.config.ts` - RabbitMQ configuration
- `src/config/novu.config.ts` - Novu configuration
- `src/config/auth.config.ts` - Auth service configuration
- `src/config/app.config.ts` - Application configuration

**Database Schemas:**

- `src/infrastructure/database/schemas/user.schema.ts` - User schema
- `src/infrastructure/database/schemas/device-token.schema.ts` - Device token schema
- `src/infrastructure/database/schemas/announcement.schema.ts` - Announcement schema
- `src/infrastructure/database/schemas/user-notification.schema.ts` - User notification schema
- `src/infrastructure/database/schemas/category.schema.ts` - Category schema
- `src/infrastructure/database/schemas/category-member.schema.ts` - Category member schema
- `src/infrastructure/database/schemas/user-preferences.schema.ts` - User preferences schema
- `src/infrastructure/database/schemas/notification-template.schema.ts` - Notification template schema

**Infrastructure Services:**

- `src/infrastructure/database/mongoose.service.ts` - MongoDB connection service
- `src/infrastructure/database/mongoose.module.ts` - MongoDB module
- `src/infrastructure/cache/redis.service.ts` - Redis cache service
- `src/infrastructure/cache/redis.module.ts` - Redis module
- `src/infrastructure/messaging/rabbitmq.service.ts` - RabbitMQ service
- `src/infrastructure/messaging/rabbitmq.module.ts` - RabbitMQ module
- `src/infrastructure/external/circuit-breaker/circuit-breaker.service.ts` - Circuit breaker service
- `src/infrastructure/external/circuit-breaker/circuit-breaker.module.ts` - Circuit breaker module
- `src/infrastructure/external/novu/novu.client.ts` - Novu client
- `src/infrastructure/external/novu/novu.module.ts` - Novu module
- `src/infrastructure/external/auth-service/auth-service.client.ts` - Auth service client
- `src/infrastructure/external/auth-service/auth-service.module.ts` - Auth service module

**Common Utilities:**

- `src/common/decorators/` - Custom decorators (current-user, roles, api-response, admin-only)
- `src/common/guards/` - Authentication and authorization guards
- `src/common/interceptors/` - Cross-cutting concerns interceptors
- `src/common/pipes/` - Input validation pipes
- `src/common/dto/` - Common DTOs
- `src/common/enums/` - Application enums
- `src/common/utils/` - Utility functions
- `src/common/constants/` - Application constants

**Health Check:**

- `src/modules/health/health.controller.ts` - Health check controller
- `src/modules/health/health.service.ts` - Health check service
- `src/modules/health/health.module.ts` - Health check module

**Testing Infrastructure:**

- `test/setup.ts` - Test setup configuration
- `test/factories/` - Test data factories
- `test/fixtures/` - Static test data
- `test/unit/` - Unit test examples
- `test/integration/` - Integration test examples
- `test/e2e/` - End-to-end test examples

**Docker Configuration:**

- `infrastructure/docker/docker-compose.yml` - Development Docker Compose
- `infrastructure/docker/docker-compose.prod.yml` - Production Docker Compose
- `infrastructure/docker/Dockerfile` - Application Dockerfile
- `infrastructure/docker/scripts/mongodb-init.js` - MongoDB initialization script

## QA Results

_Results from QA Agent review will be added here after implementation_
