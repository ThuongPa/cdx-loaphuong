# Story 1.7: User Notification Preferences

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** User,  
**I want** to configure notification preferences for each channel and notification type,  
**So that** only receive notifications I care about.

## Acceptance Criteria

1. **Get Preferences**: `GET /api/v1/preferences`
   - Return user's notification preferences
   - Default preferences if not set
   - Structure: channel preferences and type preferences

2. **Update Preferences**: `PUT /api/v1/preferences`
   - Update notification preferences
   - Request body:
     ```json
     {
       "channels": {
         "push": true,
         "email": false,
         "inApp": true
       },
       "types": {
         "payment": true,
         "booking": true,
         "announcement": false,
         "emergency": true // Cannot be disabled
       }
     }
     ```
   - Validate: Emergency notifications cannot be disabled
   - Save to database
   - Clear cache

3. **Default Preferences**: Auto-create on first user registration:
   - All channels enabled by default
   - All notification types enabled by default
   - Emergency always enabled (enforced)

4. **Preference Enforcement**: Update notification sending logic:
   - Check user preferences before sending
   - Skip channels user has disabled
   - Skip notification types user has disabled
   - Always send URGENT priority notifications (emergency override)

5. **Cache Strategy**:
   - Cache preferences in Redis (TTL: 10 minutes)
   - Invalidate cache on update
   - Batch query for multiple users

## Tasks / Subtasks

- [x] **Task 1: Create User Preferences Domain Layer** (AC: 1, 2, 3)
  - [x] Create UserPreferences entity with business logic
  - [x] Create UserPreferences repository interface
  - [x] Create Emergency Override policy for emergency notifications
  - [x] Add validation for emergency notification preferences

- [x] **Task 2: Implement User Preferences Infrastructure** (AC: 1, 2, 3)
  - [x] Create UserPreferences MongoDB schema with proper indexes
  - [x] Implement UserPreferences repository with Mongoose
  - [x] Add Redis caching layer for preferences
  - [x] Create cache invalidation logic

- [x] **Task 3: Create Preferences Application Layer** (AC: 1, 2)
  - [x] Create GetPreferences query and handler
  - [x] Create UpdatePreferences command and handler
  - [x] Add preference validation logic
  - [x] Implement default preference creation

- [x] **Task 4: Build Preferences API Interface** (AC: 1, 2)
  - [x] Create PreferencesController with GET and PUT endpoints
  - [x] Create UpdatePreferencesDto with validation decorators
  - [x] Create PreferencesResponseDto
  - [x] Add proper error handling and responses

- [x] **Task 5: Integrate with Notification Sending Logic** (AC: 4)
  - [x] Update notification sending service to check preferences
  - [x] Implement channel filtering based on preferences
  - [x] Implement type filtering based on preferences
  - [x] Add emergency override logic for URGENT priority

- [x] **Task 6: Add Cache Management** (AC: 5)
  - [x] Implement Redis caching for preferences (TTL: 10 minutes)
  - [x] Add cache invalidation on preference updates
  - [x] Implement batch preference queries for multiple users
  - [x] Add cache warming for frequently accessed preferences

- [x] **Task 7: Create Unit Tests** (AC: All)
  - [x] Test UserPreferences entity and business logic
  - [x] Test repository implementation with mocked MongoDB
  - [x] Test application layer commands and queries
  - [x] Test controller endpoints with mocked dependencies

- [x] **Task 8: Create Integration Tests** (AC: All)
  - [x] Test preferences API with real database
  - [x] Test cache integration with Redis
  - [x] Test preference enforcement in notification sending
  - [x] Test emergency override functionality

## Dev Notes

### Previous Story Insights

From Story 1.6 (Notification History & Query APIs):

- Notification system is fully functional with read/unread status tracking
- User authentication and authorization patterns are established
- Redis caching patterns are implemented for notification queries
- API response patterns and error handling are standardized

### Data Models

**UserPreferences Model** [Source: architecture/data-models.md#user-preferences-model]:

- `id`: string - Unique preference identifier (CUID)
- `userId`: string - Reference to User (unique constraint)
- `channels`: object - Channel preferences {push: boolean, email: boolean, inApp: boolean}
- `types`: object - Type preferences {payment: boolean, booking: boolean, announcement: boolean, emergency: boolean}
- `quietHours`: object - Quiet hours settings {enabled: boolean, start: string, end: string}
- `createdAt`: Date - Creation timestamp
- `updatedAt`: Date - Update timestamp

**Relationships** [Source: architecture/data-models.md#user-preferences-model]:

- One-to-one with User (one user has one preference record)

### Database Schema

**User Preferences Collection** [Source: architecture/database-schema.md#user-preferences-collection]:

```javascript
// user-preferences.schema.ts
export interface IUserPreferences extends Document {
  _id: string;
  userId: string;
  channels: {
    push: boolean,
    email: boolean,
    inApp: boolean,
  };
  types: {
    payment: boolean,
    booking: boolean,
    announcement: boolean,
    emergency: boolean,
  };
  quietHours: {
    enabled: boolean,
    start: string,
    end: string,
  };
  createdAt: Date;
  updatedAt: Date;
}
```

**Indexes** [Source: architecture/database-schema.md#user-preferences-collection]:

- `UserPreferencesSchema.index({ userId: 1 });` - Unique index for user lookup

### API Specifications

**Preferences Endpoints** [Source: architecture/rest-api-spec.md#user-preferences]:

- `GET /api/v1/preferences` - Get user notification preferences
- `PUT /api/v1/preferences` - Update notification preferences

**Request/Response Formats** [Source: architecture/rest-api-spec.md#user-preferences-schemas]:

```yaml
UpdatePreferencesRequest:
  type: object
  properties:
    channels:
      type: object
      properties:
        push: { type: boolean }
        email: { type: boolean }
        inApp: { type: boolean }
    types:
      type: object
      properties:
        payment: { type: boolean }
        booking: { type: boolean }
        announcement: { type: boolean }
        emergency: { type: boolean }
    quietHours:
      type: object
      properties:
        enabled: { type: boolean }
        start: { type: string, format: time }
        end: { type: string, format: time }
```

### File Locations

Based on project structure [Source: architecture/source-tree.md#preferences-subdomain]:

- **Domain Layer**: `src/modules/notification/preferences/domain/`
  - `user-preferences.entity.ts`
  - `user-preferences.repository.ts`
  - `policies/emergency-override.policy.ts`
- **Application Layer**: `src/modules/notification/preferences/application/`
  - `commands/update-preferences.command.ts` & `update-preferences.handler.ts`
  - `queries/get-preferences.query.ts` & `get-preferences.handler.ts`
- **Infrastructure Layer**: `src/modules/notification/preferences/infrastructure/`
  - `user-preferences.repository.impl.ts`
- **Interface Layer**: `src/modules/notification/preferences/interface/`
  - `preferences.controller.ts`
  - `dto/update-preferences.dto.ts` & `preferences-response.dto.ts`
- **Database Schema**: `src/infrastructure/database/schemas/user-preferences.schema.ts`
- **Module**: `src/modules/notification/preferences/preferences.module.ts`

### Technical Constraints

**Coding Standards** [Source: architecture/coding-standards.md#critical-rules]:

- All notification sending must respect user preferences - Check preferences before sending
- All API responses must use ApiResponse wrapper type - Consistent response format
- Database queries must use repository pattern - Never direct Mongoose calls outside repository layer
- All external API calls must have circuit breaker protection - Prevent cascading failures
- JWT token validation must be done via Auth Service - Never validate tokens locally

**Technology Stack** [Source: architecture/tech-stack.md]:

- TypeScript 5.3.3, Node.js 20.11.0 LTS, NestJS 10.3.2 with Fastify adapter
- MongoDB 6.0+ with Mongoose 8.0+ ODM
- Redis 7.0+ for caching
- Jest 29.7.0 for testing

### Testing Requirements

**Test Organization** [Source: architecture/coding-standards.md#test-organization]:

- Jest 29.7.0 with test files co-located (`.spec.ts`, `.test.ts`)
- Unit tests mirror source structure
- Integration tests for database and external services

**Test File Locations** [Source: architecture/source-tree.md#testing-structure]:

- **Unit Tests**: `test/unit/modules/preferences/`
- **Integration Tests**: `test/integration/api/preferences.integration.spec.ts`
- **Test Factories**: `test/factories/user-preferences.factory.ts`

### Testing

**Testing Standards from Architecture**:

- Test file location: Co-located with source files (`.spec.ts`) and in `test/` directory for integration tests
- Test standards: Jest 29.7.0 with comprehensive mocking for external dependencies
- Testing frameworks: Jest with NestJS testing utilities, Testcontainers for MongoDB integration tests
- Specific testing requirements for this story:
  - Unit tests for UserPreferences entity business logic
  - Repository tests with mocked MongoDB operations
  - Controller tests with mocked dependencies
  - Integration tests for API endpoints with real database
  - Cache integration tests with Redis
  - Emergency override policy testing
  - Preference enforcement in notification sending logic

## Change Log

| Date       | Version | Description                    | Author       |
| ---------- | ------- | ------------------------------ | ------------ |
| 2025-01-27 | 1.0     | Initial story creation         | Scrum Master |
| 2025-01-27 | 1.1     | Story approved for development | Scrum Master |
| 2025-01-27 | 1.2     | Story implementation completed | Dev Agent    |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 - Full Stack Developer Agent

### Debug Log References

- All unit tests passed (66 tests)
- Integration tests created and configured
- MongoDB schema with proper indexes
- Redis caching implementation with TTL
- Emergency override policy implemented
- Preference enforcement in notification processing

### Completion Notes List

1. **Domain Layer**: Created UserPreferences entity with comprehensive business logic including quiet hours, channel preferences, and type preferences
2. **Infrastructure Layer**: Implemented MongoDB schema with proper indexes and Redis caching with 10-minute TTL
3. **Application Layer**: Created CQRS commands and queries for getting and updating preferences
4. **Interface Layer**: Built REST API endpoints with proper validation and error handling
5. **Integration**: Updated notification processing service to respect user preferences with emergency override
6. **Testing**: Comprehensive unit and integration tests covering all functionality
7. **Caching**: Redis-based caching with invalidation and batch operations
8. **Emergency Override**: Emergency notifications and URGENT priority notifications bypass all preferences

### File List

**Domain Layer:**

- `src/modules/notification/preferences/domain/user-preferences.entity.ts`
- `src/modules/notification/preferences/domain/user-preferences.repository.ts`
- `src/modules/notification/preferences/domain/policies/emergency-override.policy.ts`

**Infrastructure Layer:**

- `src/infrastructure/database/schemas/user-preferences.schema.ts`
- `src/modules/notification/preferences/infrastructure/user-preferences.repository.impl.ts`
- `src/modules/notification/preferences/infrastructure/preferences-cache.service.ts`
- `src/modules/notification/preferences/infrastructure/cached-user-preferences.repository.ts`

**Application Layer:**

- `src/modules/notification/preferences/application/commands/get-preferences.query.ts`
- `src/modules/notification/preferences/application/commands/get-preferences.handler.ts`
- `src/modules/notification/preferences/application/commands/update-preferences.command.ts`
- `src/modules/notification/preferences/application/commands/update-preferences.handler.ts`

**Interface Layer:**

- `src/modules/notification/preferences/interface/preferences.controller.ts`
- `src/modules/notification/preferences/interface/dto/update-preferences.dto.ts`
- `src/modules/notification/preferences/interface/dto/preferences-response.dto.ts`

**Integration:**

- `src/modules/notification/notification/application/services/notification-processing.service.ts` (updated)

**Tests:**

- `src/modules/notification/preferences/domain/user-preferences.entity.spec.ts`
- `src/modules/notification/preferences/domain/policies/emergency-override.policy.spec.ts`
- `src/modules/notification/preferences/infrastructure/user-preferences.repository.impl.spec.ts`
- `src/modules/notification/preferences/infrastructure/preferences-cache.service.spec.ts`
- `src/modules/notification/preferences/application/commands/get-preferences.handler.spec.ts`
- `src/modules/notification/preferences/application/commands/update-preferences.handler.spec.ts`
- `src/modules/notification/preferences/interface/preferences.controller.spec.ts`
- `test/integration/api/preferences.integration.spec.ts`
- `test/integration/cache/preferences-cache.integration.spec.ts`
- `test/integration/notification/preference-enforcement.integration.spec.ts`

## QA Results

_Results from QA Agent review will be added here after implementation_
