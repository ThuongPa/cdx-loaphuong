# Story 1.6: Notification History & Query APIs

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Resident/Staff User,  
**I want** APIs to view notification history and notification details,  
**So that** can review received notifications.

## Acceptance Criteria

1. **Get Notification History**: `GET /api/v1/notifications`
   - Authenticated endpoint
   - Pagination support (page, limit)
   - Filter by: type, channel, status, date range
   - Sort by: createdAt (desc by default)
   - Return: notification list with metadata

2. **Get Notification Detail**: `GET /api/v1/notifications/:id`
   - Return full notification details
   - Include: title, body, data, channels, status, timestamps
   - Security: User can only view their own notifications

3. **Mark as Read**: `PATCH /api/v1/notifications/:id/read`
   - Update notification read status
   - Timestamp when read
   - Emit NotificationRead event

4. **Mark All as Read**: `POST /api/v1/notifications/read-all`
   - Bulk update all unread notifications
   - Return count of updated notifications

5. **Get Unread Count**: `GET /api/v1/notifications/unread-count`
   - Fast query for unread notification count
   - Cached in Redis for performance

6. **Performance Optimization**:
   - Cache recent notifications in Redis (TTL: 5 minutes)
   - Database indexes on userId, createdAt, status
   - Limit pagination to reasonable size (max 100 per page)

## Tasks / Subtasks

- [x] **Task 1: Create Query Handlers (AC: 1, 2, 5)**
  - [x] Create `GetNotificationHistoryQuery` and handler
  - [x] Create `GetNotificationDetailQuery` and handler
  - [x] Create `GetUnreadCountQuery` and handler
  - [x] Implement pagination logic with proper validation
  - [x] Add filtering by type, channel, status, date range
  - [x] Add sorting by createdAt (desc by default)

- [x] **Task 2: Create Command Handlers (AC: 3, 4)**
  - [x] Create `MarkAsReadCommand` and handler
  - [x] Create `MarkAllAsReadCommand` and handler
  - [x] Implement bulk update logic for mark all as read
  - [x] Emit `NotificationRead` domain event
  - [x] Update notification status and readAt timestamp

- [x] **Task 3: Create Controller and DTOs (AC: 1-5)**
  - [x] Create `NotificationController` with all endpoints
  - [x] Create request/response DTOs for all endpoints
  - [x] Add proper validation decorators to DTOs
  - [x] Implement authentication guards
  - [x] Add proper HTTP status codes and error handling

- [x] **Task 4: Implement Caching Strategy (AC: 5, 6)**
  - [x] Add Redis caching for unread count
  - [x] Add Redis caching for recent notifications (TTL: 5 minutes)
  - [x] Implement cache invalidation on read operations
  - [x] Add cache key management service

- [x] **Task 5: Database Optimization (AC: 6)**
  - [x] Verify database indexes on userId, createdAt, status
  - [x] Add compound indexes for common query patterns
  - [x] Implement pagination limits (max 100 per page)
  - [x] Add query performance monitoring

- [x] **Task 6: Unit Tests**
  - [x] Test all query handlers with mocked repositories
  - [x] Test all command handlers with mocked repositories
  - [x] Test controller endpoints with mocked services
  - [x] Test caching logic and cache invalidation
  - [x] Test pagination and filtering logic

- [x] **Task 7: Integration Tests**
  - [x] Test complete notification history flow
  - [x] Test mark as read functionality
  - [x] Test caching integration with Redis
  - [x] Test database queries with real MongoDB

## Dev Notes

### Previous Story Insights

From Story 1.5, the notification domain models and infrastructure are already implemented:

- `UserNotification` aggregate with read status tracking
- `NotificationRepository` with basic CRUD operations
- Domain events for notification state changes
- MongoDB schemas with proper indexes

### Data Models

**UserNotification Model** [Source: architecture/data-models.md#user-notification-model]:

- `id`: string (CUID)
- `userId`: string (reference to User)
- `announcementId`: string (reference to Announcement)
- `title`: string (notification title)
- `body`: string (notification body)
- `type`: string (payment, booking, announcement, emergency)
- `channel`: string (push, email, inApp)
- `priority`: string (urgent, high, normal, low)
- `data`: object (additional notification data)
- `status`: string (pending, sent, delivered, failed, read)
- `sentAt`: Date (when notification was sent)
- `deliveredAt`: Date (when notification was delivered)
- `readAt`: Date (when user read the notification)
- `createdAt`: Date (record creation timestamp)
- `updatedAt`: Date (record update timestamp)

### API Specifications

**REST API Endpoints** [Source: architecture/rest-api-spec.md#notification-history]:

- `GET /api/v1/notifications` - Get paginated notification history with filters
- `GET /api/v1/notifications/:id` - Get notification details
- `PATCH /api/v1/notifications/:id/read` - Mark notification as read
- `POST /api/v1/notifications/read-all` - Mark all notifications as read
- `GET /api/v1/notifications/unread-count` - Get unread count

**Request/Response Formats**:

- Pagination: `{ page: number, limit: number }` with response `{ data: [], meta: { page, limit, total, totalPages, hasNext, hasPrev } }`
- Filters: `{ type?, channel?, status?, startDate?, endDate? }`
- Response: `{ id, title, body, type, channel, priority, status, data, sentAt, deliveredAt, readAt, createdAt }`

### File Locations

Based on project structure [Source: architecture/source-tree.md#notification-subdomain]:

**Application Layer (CQRS)**:

- `src/modules/notification/notification/application/queries/get-notification-history.query.ts`
- `src/modules/notification/notification/application/queries/get-notification-history.handler.ts`
- `src/modules/notification/notification/application/queries/get-notification.query.ts`
- `src/modules/notification/notification/application/queries/get-notification.handler.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.query.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.handler.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.command.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.handler.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.command.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.handler.ts`

**Interface Layer**:

- `src/modules/notification/notification/interface/notification.controller.ts`
- `src/modules/notification/notification/interface/dto/notification-history.dto.ts`
- `src/modules/notification/notification/interface/dto/notification-detail.dto.ts`
- `src/modules/notification/notification/interface/dto/mark-as-read.dto.ts`

**Infrastructure Layer**:

- `src/infrastructure/cache/notification-cache.service.ts` (new)
- `src/infrastructure/database/schemas/user-notification.schema.ts` (existing)

### Testing Requirements

**Testing Standards** [Source: architecture/test-strategy-and-standards.md]:

- **Framework**: Jest 29.7.0 with TypeScript support
- **File Convention**: `*.spec.ts` for unit tests, co-located with source files
- **Coverage Requirement**: 80% minimum, 90% for domain layer
- **Pattern**: AAA pattern (Arrange, Act, Assert)
- **Mocking**: Mock all external dependencies (Redis, MongoDB)

**Test Files to Create**:

- `src/modules/notification/notification/application/queries/get-notification-history.handler.spec.ts`
- `src/modules/notification/notification/application/queries/get-notification.handler.spec.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.handler.spec.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.handler.spec.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.handler.spec.ts`
- `src/modules/notification/notification/interface/notification.controller.spec.ts`

### Technical Constraints

**Coding Standards** [Source: architecture/coding-standards.md]:

- All API responses must use ApiResponse wrapper type
- Database queries must use repository pattern
- All external API calls must have circuit breaker protection
- JWT token validation must be done via Auth Service
- All database operations must use transactions for multi-document updates
- Use CUID for all entity IDs
- DTOs must use class-validator decorators
- Use dependency injection pattern
- Async/await preferred over Promises

**Performance Requirements**:

- Cache recent notifications in Redis (TTL: 5 minutes)
- Database indexes on userId, createdAt, status
- Limit pagination to reasonable size (max 100 per page)
- Fast unread count query with Redis caching

### Project Structure Notes

The notification subdomain follows DDD + CQRS structure with clear separation between:

- Application layer (commands/queries)
- Domain layer (aggregates, repositories)
- Infrastructure layer (implementations)
- Interface layer (controllers, DTOs)

All new files should follow this structure and use existing patterns from Story 1.5 implementation.

## Testing

### Testing Standards

**Framework**: Jest 29.7.0 with TypeScript support
**File Convention**: `*.spec.ts` for unit tests, co-located with source files
**Coverage Requirement**: 80% minimum, 90% for domain layer
**Pattern**: AAA pattern (Arrange, Act, Assert)
**Mocking**: Mock all external dependencies (Redis, MongoDB)

### Test Types Required

1. **Unit Tests**: All query/command handlers, controller endpoints, caching logic
2. **Integration Tests**: Complete notification history flow, Redis caching, database queries
3. **E2E Tests**: Full API flow from request to response

### Test Data Management

- Use factory pattern for test data generation
- Mock Redis and MongoDB for unit tests
- Use Testcontainers for integration tests
- Clean up test data after each test

## Change Log

| Date       | Version | Description                    | Author            |
| ---------- | ------- | ------------------------------ | ----------------- |
| 2025-01-27 | 1.0     | Initial story creation         | Scrum Master      |
| 2025-01-27 | 1.1     | Story implementation completed | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor AI)

### Debug Log References

No debug logs generated during implementation

### Completion Notes List

1. **Query Handlers Implementation**: Successfully implemented all query handlers with proper error handling and validation
2. **Command Handlers Implementation**: Created mark as read and mark all as read handlers with security checks
3. **Controller Implementation**: Built RESTful API endpoints with proper authentication and validation
4. **Caching Strategy**: Implemented Redis caching for notification history and unread count with TTL
5. **Database Optimization**: Added compound indexes and optimized queries for better performance
6. **Unit Tests**: Created comprehensive unit tests for all handlers and controllers
7. **Integration Tests**: Built integration tests for API endpoints, database queries, and caching

### File List

**Application Layer (CQRS)**:

- `src/modules/notification/notification/application/queries/get-notification-history.query.ts`
- `src/modules/notification/notification/application/queries/get-notification-history.handler.ts`
- `src/modules/notification/notification/application/queries/get-notification.query.ts`
- `src/modules/notification/notification/application/queries/get-notification.handler.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.query.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.handler.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.command.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.handler.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.command.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.handler.ts`

**Interface Layer**:

- `src/modules/notification/notification/interface/notification.controller.ts`
- `src/modules/notification/notification/interface/dto/notification-history.dto.ts`
- `src/modules/notification/notification/interface/dto/notification-detail.dto.ts`
- `src/modules/notification/notification/interface/dto/mark-as-read.dto.ts`

**Infrastructure Layer**:

- `src/infrastructure/cache/notification-cache.service.ts`

**Module Configuration**:

- `src/modules/notification/notification/notification.module.ts`
- `src/app.module.ts` (updated to include NotificationModule)

**Database Schema Updates**:

- `src/infrastructure/database/schemas/user-notification.schema.ts` (added readAt field and optimized indexes)

**Unit Tests**:

- `src/modules/notification/notification/application/queries/get-notification-history.handler.spec.ts`
- `src/modules/notification/notification/application/queries/get-notification.handler.spec.ts`
- `src/modules/notification/notification/application/queries/get-unread-count.handler.spec.ts`
- `src/modules/notification/notification/application/commands/mark-as-read.handler.spec.ts`
- `src/modules/notification/notification/application/commands/mark-all-read.handler.spec.ts`
- `src/modules/notification/notification/interface/notification.controller.spec.ts`

**Integration Tests**:

- `test/integration/api/notification-history.integration.spec.ts`
- `test/integration/database/notification-repository.integration.spec.ts`
- `test/integration/external/notification-cache.integration.spec.ts`

## QA Results

_Results from QA Agent review will be added here after implementation_
