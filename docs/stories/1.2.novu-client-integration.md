# Story 1.2: Novu Client Integration

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Backend Developer,  
**I want** to integrate Novu client SDK and implement wrapper service,  
**So that** can send notifications via Novu API reliably.

## Acceptance Criteria

1. **Novu Client Service**: NestJS service wrapper for Novu SDK:
   - Connection management with Novu self-hosted API
   - Subscriber management (create, update, get subscribers)
   - Workflow triggering for push, in-app, email
   - Error handling and retry logic
   - Circuit breaker pattern for Novu API calls

2. **Subscriber Sync**: Logic to sync users with Novu subscribers:
   - Create subscriber when user registers push token for first time
   - Update subscriber data (email, phone) from Auth Service
   - Manage subscriber preferences

3. **Workflow Configuration**: Setup Novu workflows:
   - Push notification workflow
   - In-app notification workflow
   - Email notification workflow
   - Template variables mapping

4. **Testing**: Unit tests for Novu client with mocked API responses

5. **Configuration**: Environment variables for Novu:
   - `NOVU_API_URL`
   - `NOVU_API_KEY`
   - `NOVU_APPLICATION_IDENTIFIER`

## Tasks / Subtasks

- [x] Task 1: Setup Novu Client Service (AC: 1)
  - [x] Install Novu SDK package
  - [x] Create Novu configuration module
  - [x] Implement Novu client service with connection management
  - [x] Add environment variables configuration
  - [x] Implement circuit breaker pattern for API calls

- [x] Task 2: Implement Subscriber Management (AC: 2)
  - [x] Create subscriber creation logic
  - [x] Implement subscriber update functionality
  - [x] Add subscriber data sync from Auth Service
  - [x] Handle subscriber preferences management
  - [x] Add error handling for subscriber operations

- [x] Task 3: Setup Workflow Configuration (AC: 3)
  - [x] Create push notification workflow
  - [x] Setup in-app notification workflow
  - [x] Configure email notification workflow
  - [x] Implement template variables mapping
  - [x] Add workflow trigger functionality

- [x] Task 4: Implement Error Handling & Retry Logic (AC: 1)
  - [x] Add retry logic with exponential backoff
  - [x] Implement error classification (retryable vs non-retryable)
  - [x] Add circuit breaker implementation
  - [x] Create error logging and monitoring

- [x] Task 5: Write Unit Tests (AC: 4)
  - [x] Test Novu client service with mocked API responses
  - [x] Test subscriber management operations
  - [x] Test workflow triggering functionality
  - [x] Test error handling and retry logic
  - [x] Test circuit breaker behavior

## Dev Notes

### Previous Story Insights

- Story 1.1 established the basic NestJS project structure with DDD + CQRS patterns
- MongoDB schemas are already defined for users, device tokens, and notifications
- Infrastructure layer is set up with Mongoose, Redis, and RabbitMQ services

### Data Models

Based on architecture documents, the following data models are relevant:

- **User Model**: Contains email, phone, roles for subscriber sync [Source: architecture/data-models.md#user-model]
- **DeviceToken Model**: Manages FCM/APNS tokens for push notifications [Source: architecture/data-models.md#device-token-model]
- **UserPreferences Model**: Stores channel and type preferences [Source: architecture/data-models.md#user-preferences-model]

### API Specifications

**Novu Self-hosted API Integration:**

- Base URL: `{NOVU_API_URL}/v1` [Source: architecture/external-apis.md#novu-self-hosted-api]
- Authentication: API Key (`Authorization: ApiKey {NOVU_API_KEY}`)
- Key Endpoints:
  - `POST /subscribers` - Create new subscriber
  - `PUT /subscribers/{subscriberId}` - Update subscriber
  - `DELETE /subscribers/{subscriberId}` - Delete subscriber
  - `POST /events/trigger` - Trigger notification workflow
  - `GET /events/{eventId}` - Get delivery status
- Rate Limits: 1000 requests/minute (configurable)
- Integration Notes: Use circuit breaker pattern, implement retry logic with exponential backoff, cache subscriber data

### Component Specifications

**Novu Client Service Location:**

- File: `src/infrastructure/external/novu/novu.client.ts` [Source: architecture/source-tree.md#infrastructure-external-novu]
- Module: `src/infrastructure/external/novu/novu.module.ts`
- Configuration: `src/config/novu.config.ts`

**Service Structure:**

- Connection management with Novu self-hosted API
- Subscriber management (create, update, get subscribers)
- Workflow triggering for push, in-app, email
- Error handling and retry logic
- Circuit breaker pattern for Novu API calls

### File Locations

Based on project structure:

- Novu client service: `src/infrastructure/external/novu/novu.client.ts`
- Novu module: `src/infrastructure/external/novu/novu.module.ts`
- Novu configuration: `src/config/novu.config.ts`
- Circuit breaker service: `src/infrastructure/external/circuit-breaker/circuit-breaker.service.ts`
- Environment variables: `.env.example` (add Novu config)

### Testing Requirements

**Unit Testing Standards:**

- Framework: Jest 29.7.0 with TypeScript support [Source: architecture/test-strategy-and-standards.md#unit-tests]
- File Convention: `*.spec.ts` for unit tests, co-located with source files
- Location: Mirror source structure in `test/unit/` directory
- Coverage Requirement: 80% minimum, 90% for domain layer
- Mocking: Jest built-in mocking with custom mocks for external services
- Pattern: Follow AAA pattern (Arrange, Act, Assert)

**Specific Testing Requirements:**

- Mock all external dependencies (Novu API)
- Cover edge cases and error conditions
- Test circuit breaker behavior
- Test retry logic with exponential backoff
- Test subscriber management operations
- Test workflow triggering functionality

### Technical Constraints

**Coding Standards:**

- All external API calls must have circuit breaker protection [Source: architecture/coding-standards.md#critical-rules]
- Never use console.log in production code - Always use Winston logger
- Use dependency injection pattern - NestJS standard
- Async/await preferred over Promises
- Use CUID for all entity IDs
- All database operations must use transactions for multi-document updates

**Environment Configuration:**

- `NOVU_API_URL`: Novu self-hosted instance URL
- `NOVU_API_KEY`: API key for authentication
- `NOVU_APPLICATION_IDENTIFIER`: Application identifier in Novu

### Integration Verification

- IV1: Novu client connects successfully with Novu self-hosted API
- IV2: Test subscriber creation and update successfully
- IV3: Test workflow trigger with mocked data successfully
- IV4: Circuit breaker works when Novu API is down (failover gracefully)

## Testing

### Testing Standards

- **Framework**: Jest 29.7.0 with TypeScript support
- **File Convention**: `*.spec.ts` for unit tests, co-located with source files
- **Location**: `test/unit/infrastructure/external/novu/`
- **Coverage Requirement**: 80% minimum
- **Mocking**: Jest built-in mocking with custom mocks for Novu API
- **Pattern**: Follow AAA pattern (Arrange, Act, Assert)

### Specific Testing Requirements

- Mock Novu SDK API responses
- Test connection management and error handling
- Test subscriber CRUD operations
- Test workflow triggering with different notification types
- Test circuit breaker behavior (open, half-open, closed states)
- Test retry logic with exponential backoff
- Test error classification (retryable vs non-retryable errors)

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-01-27 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None

### Completion Notes List

- Installed @novu/api package (version 1.7.1)
- Updated Novu SDK from deprecated @novu/node to @novu/api
- Implemented NovuClient with proper API methods (trigger, subscribers.create, subscribers.patch, subscribers.retrieve, subscribers.delete, workflows.create, workflows.update, workflows.delete, workflows.get, workflows.list)
- Created NovuSubscriberService for managing subscriber sync with Auth Service
- Created NovuWorkflowService for managing notification workflows
- Created NovuRetryService for retry logic with exponential backoff
- Integrated circuit breaker pattern for all Novu API calls
- Added environment variables: NOVU_API_KEY, NOVU_SECRET_KEY, NOVU_API_URL, NOVU_APPLICATION_IDENTIFIER
- Wrote comprehensive unit tests for all services
- Fixed package.json dependencies (cuid, tsconfig-paths)

### File List

**Created:**

- `src/infrastructure/external/novu/novu.client.ts` - Novu API client wrapper
- `src/infrastructure/external/novu/novu-subscriber.service.ts` - Subscriber management service
- `src/infrastructure/external/novu/novu-workflow.service.ts` - Workflow management service
- `src/infrastructure/external/novu/novu-retry.service.ts` - Retry logic service
- `test/unit/infrastructure/external/novu/novu.client.spec.ts` - Unit tests for NovuClient
- `test/unit/infrastructure/external/novu/novu-subscriber.service.spec.ts` - Unit tests for NovuSubscriberService
- `test/unit/infrastructure/external/novu/novu-workflow.service.spec.ts` - Unit tests for NovuWorkflowService
- `test/unit/infrastructure/external/novu/novu-retry.service.spec.ts` - Unit tests for NovuRetryService

**Modified:**

- `src/config/novu.config.ts` - Added NOVU_SECRET_KEY and NOVU_APPLICATION_IDENTIFIER
- `src/infrastructure/external/novu/novu.module.ts` - Added new services to exports
- `env.example` - Added Novu configuration variables
- `package.json` - Fixed cuid and tsconfig-paths versions, added @novu/api

## QA Results

_Results from QA Agent review will be added here_
