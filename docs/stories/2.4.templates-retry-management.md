# Story 2.4: Templates & Retry Management

## Status

âœ… **COMPLETED** - All acceptance criteria implemented and tested

## Story

**As a** Backend Developer,  
**I want** to implement notification templates management and retry mechanism for failed notifications,  
**So that** service can manage reusable templates and handle failed notifications reliably.

## Acceptance Criteria

1. **Notification Templates CRUD APIs**:
   - `POST /api/v1/templates` - Create notification template
   - `GET /api/v1/templates` - List templates with pagination
   - `GET /api/v1/templates/:id` - Get template details
   - `PUT /api/v1/templates/:id` - Update template
   - `DELETE /api/v1/templates/:id` - Delete template

2. **Template Management**:
   - Support multiple channels (push, email, in-app)
   - Template variables with validation
   - Multi-language support (vi, en)
   - Template versioning and history
   - Template activation/deactivation

3. **Template Usage**:
   - Use templates in notification sending
   - Variable substitution in template content
   - Template validation before sending
   - Fallback to default templates

4. **Retry Mechanism for Failed Notifications**:
   - Automatic retry with exponential backoff
   - Configurable retry attempts (max 3)
   - Retry delay: 1min, 5min, 15min
   - Dead letter queue for permanently failed notifications
   - Manual retry capability for admins

5. **Retry Worker Service**:
   - Background worker to process retry queue
   - Priority-based retry processing
   - Circuit breaker integration
   - Retry attempt logging and monitoring

6. **Error Classification**:
   - Retryable errors (temporary failures)
   - Non-retryable errors (permanent failures)
   - Error categorization and logging
   - Error metrics and reporting

## Tasks / Subtasks

- [x] **Task 1: Notification Templates Domain Layer** (AC: 1, 2)
  - [x] Create NotificationTemplate entity with business logic
  - [x] Create NotificationTemplate repository interface
  - [x] Add template validation and versioning logic
  - [x] Implement template variable validation
  - [x] Create template activation/deactivation logic

- [x] **Task 2: Templates Infrastructure Layer** (AC: 1, 2)
  - [x] Create NotificationTemplate MongoDB schema
  - [x] Implement NotificationTemplate repository with Mongoose
  - [x] Add template indexing for performance
  - [x] Create template caching layer with Redis
  - [x] Implement template versioning in database

- [x] **Task 3: Templates Application Layer** (AC: 1, 2)
  - [x] Create CreateTemplate command and handler
  - [x] Create UpdateTemplate command and handler
  - [x] Create DeleteTemplate command and handler
  - [x] Create GetTemplates query and handler
  - [x] Create GetTemplate query and handler

- [x] **Task 4: Templates API Interface** (AC: 1)
  - [x] Create TemplatesController with CRUD endpoints
  - [x] Create template DTOs with validation decorators
  - [x] Add proper error handling and responses
  - [x] Implement template pagination and filtering
  - [x] Add template search functionality

- [x] **Task 5: Template Usage Integration** (AC: 3)
  - [x] Update notification sending service to use templates
  - [x] Implement template variable substitution
  - [x] Add template validation before sending
  - [x] Create fallback to default templates
  - [x] Integrate with existing notification processing

- [x] **Task 6: Retry Mechanism Implementation** (AC: 4, 5)
  - [x] Create retry service with exponential backoff
  - [x] Implement retry queue management
  - [x] Add retry attempt tracking and limits
  - [x] Create dead letter queue for failed notifications
  - [x] Implement retry worker service

- [x] **Task 7: Error Classification System** (AC: 6)
  - [x] Create error classification service
  - [x] Implement retryable vs non-retryable error detection
  - [x] Add error categorization and logging
  - [x] Create error metrics and reporting
  - [x] Implement error recovery strategies

- [x] **Task 8: Unit Tests** (AC: All)
  - [x] Test NotificationTemplate entity and business logic
  - [x] Test template repository operations
  - [x] Test template API endpoints
  - [x] Test retry mechanism and error classification
  - [x] Test template usage in notification sending

- [x] **Task 9: Integration Tests** (AC: All)
  - [x] Test template CRUD operations with real database
  - [x] Test template usage in notification processing
  - [x] Test retry mechanism with failed notifications
  - [x] Test error classification and recovery
  - [x] Test template caching and performance

## Dev Notes

### Previous Story Insights

From Story 2.1-2.3 (Core Features):

- Device token registration and core notification logic are complete
- Notification history and query APIs are operational
- User notification preferences are implemented
- All core notification features are ready for template and retry management

### Data Models

**NotificationTemplate Model** [Source: architecture/data-models.md#notification-template-model]:

- `id`: string (CUID) - Unique template identifier
- `name`: string - Template identifier
- `type`: string - Notification type
- `channel`: string - Target channel (push, email, inApp)
- `subject`: string - Template subject (for email)
- `body`: string - Template body with variables {{variable}}
- `language`: string - i18n support (vi, en)
- `variables`: string[] - Required template variables
- `isActive`: boolean - Template status
- `createdBy`: string - Creator user ID
- `createdAt`, `updatedAt`: Date - Timestamps

**Retry Queue Model** [Source: architecture/data-models.md#retry-queue-model]:

- `id`: string (CUID) - Unique retry identifier
- `notificationId`: string - Reference to failed notification
- `retryCount`: number - Current retry attempt
- `maxRetries`: number - Maximum retry attempts
- `nextRetryAt`: Date - Next retry timestamp
- `retryReason`: string - Reason for retry
- `status`: string - Retry status (pending, processing, completed, failed)
- `createdAt`, `updatedAt`: Date - Timestamps

### API Specifications

**Template Endpoints** [Source: architecture/rest-api-spec.md#templates]:

- `POST /api/v1/templates` - Create notification template
- `GET /api/v1/templates` - List templates with pagination
- `GET /api/v1/templates/:id` - Get template details
- `PUT /api/v1/templates/:id` - Update template
- `DELETE /api/v1/templates/:id` - Delete template

**Retry Endpoints** [Source: architecture/rest-api-spec.md#retry]:

- `POST /api/v1/notifications/:id/retry` - Manual retry failed notification
- `GET /api/v1/retry-queue` - List retry queue (admin only)
- `POST /api/v1/retry-queue/:id/cancel` - Cancel retry (admin only)

### File Locations

Based on project structure [Source: architecture/source-tree.md]:

**Templates Module:**

- `src/modules/notification/templates/domain/` - Template entities
- `src/modules/notification/templates/application/` - Commands and queries
- `src/modules/notification/templates/infrastructure/` - Repository implementation
- `src/modules/notification/templates/interface/` - API controllers

**Retry Module:**

- `src/modules/notification/retry/domain/` - Retry entities
- `src/modules/notification/retry/application/` - Retry services
- `src/modules/notification/retry/infrastructure/` - Retry implementation
- `src/workers/retry.worker.ts` - Retry background worker

### Technical Constraints

**Coding Standards** [Source: architecture/coding-standards.md]:

- Use CUID for all entity IDs (never MongoDB ObjectId)
- All external API calls must have circuit breaker protection
- All database operations must use transactions for multi-document updates
- Never use console.log - use Winston logger
- All API responses must use ApiResponse wrapper type
- Template variables must be validated before substitution

### Testing Requirements

**Testing Standards** [Source: architecture/coding-standards.md]:

- Jest 29.7.0 with test files co-located (`.spec.ts`, `.test.ts`)
- Unit tests for domain logic and services
- Integration tests with Testcontainers for database operations
- Mock external API calls (Novu, Auth Service)
- Test error handling and retry logic
- Test template variable substitution
- Test retry mechanism with various failure scenarios

## Change Log

| Date       | Version | Description                    | Author       |
| ---------- | ------- | ------------------------------ | ------------ |
| 2025-01-27 | 1.0     | Initial story creation         | Scrum Master |
| 2025-01-27 | 1.1     | Story approved for development | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after implementation_
